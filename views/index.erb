<html>
<head>
  <meta charset=utf-8 />
  <title>Tri-Met Vehicle Map</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <!-- Load Leaflet from CDN-->
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/leaflet/0.7.3/leaflet.css" />
  <script src="//cdn.jsdelivr.net/leaflet/0.7.3/leaflet.js"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="//cdn.jsdelivr.net/leaflet.esri/1.0.0/esri-leaflet.js"></script>

  <style>
    body {margin:0;padding:0;}
    #map {position: absolute;top:0;bottom:0;right:0;left:0;}
  </style>
</head>
<body>

<div id="map"></div>

<script type='text/javascript'>
  var map = L.map('map').setView([45.533, -122.657], 12);
  L.esri.basemapLayer('DarkGray').addTo(map);
  var myLayer = L.geoJson().addTo(map);

  var mywms = L.tileLayer.wms("http://localhost:8080/geoserver/tm_routes/wms", {
    layers: 'tm_routes',
    format: 'image/png',
    transparent: true,
    version: '1.1.0',
  });

  mywms.addTo(map);

  setInterval(function() {

    $.ajax({
      dataType: 'text',
      url: '/locations',
      success: function(data) {
        var geojson;
        geojson = $.parseJSON(data);
        myLayer.clearLayers()
        myLayer.addData(geojson);
      }
    });
  }, 5000);

  myLayer.on('layeradd', function(e) {
    var marker, popupContent, properties;
    marker = e.layer;
    properties = marker.feature.properties;
    popupContent =  '<div class="popup"><h3>'+ properties.route+ '</h3>'+
                 '<p><strong>Next Stop:</strong> ' + properties.next_stop + '</p>' +
                 '<p><strong>Type:</strong> ' + properties.vehicle_type + '</p>' +
                 '</div>'
    return marker.bindPopup(popupContent, {
      closeButton: false,
      minWidth: 250
    });
  });

  myLayer.on('click', function(e) {
    map.panTo(e.layer.getLatLng());
  });

</script>

</body>
</html>
